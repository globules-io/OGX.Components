/* OGX.JS Chat@1.5.0 */
if(typeof OGX==="undefined"){var OGX={}}require("Chat","Uxi","Touch");OGX.Chat=function(__config){construct(this,"Chat");"use strict";var that=this;var config=__config;var config_default={placeholder:"Type a message",dot_speed:600,on_keyb_update_delay:300,messages:[],handle_keyboard:true,hide_keyboard_on_send:false,emojis:false,media:true,attach:{width:800,height:800},template_left:'<div class="ogx_chat_message ogx_chat_message_left" style="{{$opacity}}" data-id="{{$uid}}"><span class="ogx_chat_message_icon" style="{{$bg}}"><span>{{$letter}}</span></span><span class="ogx_chat_message_container"><span class="ogx_chat_message_body">{{$body}}</span><span class="ogx_chat_message_date">{{$date}}</span><span style="clear:both"></span></span></div>',template_right:'<div class="ogx_chat_message ogx_chat_message_right" style="{{$opacity}}" data-id="{{$uid}}"><span class="ogx_chat_message_container"><span class="ogx_chat_message_body">{{$body}}</span><span class="ogx_chat_message_date">{{$date}}</span><span style="clear:both"></span></span></div>',key:"_id",from_key:"from",users:[],user:false,display_mode:OGX.Chat.DISPLAY_INITIALS,picture_key:"",restrict:{multiline:false,length:500,allowed:/./},date_format:"YYYY-MM-DD h:mm:ss A",url_encode:true,read_only:false,callbacks:{send:null}};var emojis_default={template:'<span class="ogx_chat_emoji">{{$emoji}}</span>',button:false,list:[],map:{emoji:"char",search:"name"}};var container,inner,scroller,composer,emojis,emoji_list,intv;var oldh=false;var type=".";var attachment=null;var attach_icon;var typing=false;var typing_to=null;var typing_users={};this.onFocus=function(){if(!config.read_only){if(config.handle_keyboard){listenKeyb(true)}if(config.media&&config.attach){listenFile(true)}listenComposer(true);listenArea(true)}};this.onBlur=function(){if(!config.read_only){this.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea").trigger("blur");if(config.handle_keyboard){listenKeyb(false)}if(config.media&&config.attach){listenFile(false)}listenComposer(false);listenArea(false)}};this.readOnly=function(e){if(e){if(!config.read_only){this.el.find(".ogx_chat_composer").addClass("hidden");config.read_only=true}}else{if(config.read_only){this.el.find(".ogx_chat_composer").removeClass("hidden");config.read_only=false}}};this.users=function(e){if(typeof e!=="undefined"){if(!e.hasOwnProperty("find")){e=new OGX.List(e)}config.users=e;return true}return config.users};this.user=function(e){if(typeof e==="undefined"){return config.user}config.user=e;return this};this.typing=function(e,t){if(!typing_users.hasOwnProperty(t)){typing_users[t]=false}if(e){if(!typing_users[t]){typing_users[t]=true;addTyping(t);return true}}else{if(typing_users[t]){typing_users[t]=false;removeTyping(t);return true}}return false};this.compose=function(e){composer.find("textarea").val(e);return this};this.wipe=function(){inner.empty();return this};this.clear=function(){debug(2,"Chat clear is deprecated, use wipe");return this.wipe()};this.onSend=function(){};this.getScroller=function(){return scroller};this.addMessage=function(e){addMessage(e);return this};this.setMessages=function(e){config.messages=e;render();return this};this.prependMessages=function(e){var t=this.el.find(".ogx_scroller_outer").first();var i=inner.height();var a=t.scrollTop();for(var o=0;o<e.length;o++){addMessage(e[o],true)}config.messages=e.concat(config.messages);var n=inner.height();this.el.find(".ogx_scroller_outer").scrollTop(a+(n-i));return this};this.destroy=function(){if(config.restrict){OGX.Form.unrestrictField(that.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea")[0])}OGX.Form.unbindField(".ogx_chat_composer .ogx_chat_composer_input textarea")};function render(){if(config.messages.length>0){for(var e=0;e<config.messages.length;e++){addMessage(config.messages[e])}scroller.resize();scroller.bottom()}scroller.vocal()}function addMessage(e,t){if(typeof t==="undefined"){t=false}scroller.observe(false);scroller.mute();var i=OGX.Data.clone(e);var a=config.users.find(config.key,e[config.from_key],1);i=genDisplay(a,i);if(i){i.uid=a[config.key];if(!t){i.opacity=""}else{i.opacity="opacity:1;"}if(config.url_encode){i.body=decodeURIComponent(i.body)}if(config.media&&(e.hasOwnProperty("image")||e.hasOwnProperty("video"))){if(i.hasOwnProperty("image")&&i.image){i.body='<span class="ogx_chat_message_media""><img src="{{$image}}"></span>'+i.body}else{if(i.hasOwnProperty("video")&&i.video){i.body='<span class="ogx_chat_message_media"><video controls autoplay src="{{$video}}"></video></span>'+i.body}}}var o=OGX.Templater.make(getTemplate(i),i);if(!t){inner.append(o)}else{inner.prepend(o)}var i=inner.children(".ogx_chat_message").last();setTimeout(function(){i.addClass("ogx_chat_message_anim");scroller.resize();if(!t){scroller.bottom()}scroller.vocal();scroller.observe(true)},100)}else{}}function addTyping(e){var t=config.users.find(config.key,e,1);if(t){var i=genDisplay(t,{opacity:1,uid:t,date:"",body:"."});var a=OGX.Templater.make(config.template_left,i);a='<div class="ogx_chat_typing" data-user="'+e+'">'+a+"</div>";that.observeOnce(null,()=>{scroller.bottom()});inner.append(a);animTyping(true,e);return this}return false}function genDisplay(__user,__msg){var initals=__user.first_name.substr(0,1).toUpperCase()+__user.last_name.substr(0,1).toUpperCase();switch(config.display_mode){case OGX.Chat.DISPLAY_INITIALS:__msg.letter=initals;__msg.bg="";break;case OGX.Chat.DISPLAY_PICTURE:__msg.letter="";var e=eval("__user."+config.picture_key);if(e!=="undefined"){__msg.bg="background-image:url('"+e+"')"}else{__msg.letter=initals;__msg.bg=""}break}return __msg}function removeTyping(e){animTyping(false,e);inner.find('.ogx_chat_typing[data-user="'+e+'"]').remove()}function animTyping(e,t){if(e){if(!intv){intv=setInterval(()=>{typeDot(t)},config.dot_speed)}}else{clearInterval(intv);intv=null}}function typeDot(e){type+=".";type.length>3?type=".":null;inner.find('.ogx_chat_typing[data-user="'+e+'"]').find(".ogx_chat_message_body").html(type)}function getTemplate(e){if(e[config.from_key]===config.user){return config.template_right}else{return config.template_left}}function sendMessage(){var e=composer.find("textarea").val();if(e.length){e=e.replace(/^[\r|\n\r]+/,"");e=e.replace(/<\/?[^>]+(>|$)/g,"");e=e.replace(/â€™/,"'");if(e.length){e=e.replace(/[\r\n]/g,"<br>");var t={body:e,date:moment().format(config.date_format)};t[config.from_key]=config.user;if(attachment){t.image=attachment;attachment=null;that.el.find(".ogx_chat_composer_attach").css("background-image",attach_icon);attach_icon=null}addMessage(t);var i=OGX.Data.clone(t);if(config.url_encode){i.body=encodeURIComponent(i.body)}delete i.bg;delete i.letter;composer.find("textarea").val("");config.callbacks.send(i);that.el.trigger(OGX.Chat.SEND_MESSAGE,i)}}}function onInput(){if(!typing){typing=true;that.el.trigger(OGX.Chat.TYPING_START,that)}if(typing_to){clearTimeout(typing_to)}typing_to=setTimeout(()=>{that.el.trigger(OGX.Chat.TYPING_END,that);typing_to=null;typing=false},300)}function handleShowKeyb(e){if(!oldh){oldh=container.height()}container.height(oldh-e.keyboardHeight);updateScroller()}function handleHideKeyb(){container.height(oldh);updateScroller()}function updateScroller(){setTimeout(function(){scroller.resize();scroller.bottom()},config.on_keyb_update_delay)}function renderEmojis(){var e;var t=[];config.emojis.list=config.emojis.list.slice(0,250);for(var i=0;i<config.emojis.list.length;i++){e=OGX.Data.clone(config.emojis.list[i]);for(var a in config.emojis.map){e[a]=e[config.emojis.map[a]];t.push(e)}}emoji_list=that.create("DynamicList",{id:"ogx_chat_eml_"+that.id,el:'.ogx_chat[data-ogx-id="'+that.id+'"] .ogx_chat_emojis_list',key:"codes",scroll:true,display:{html:"{{$emoji}}",css:"ogx_chat_emoji"},list:t,callbacks:{render:e=>{e.scroller.onResize()}}});emoji_list.bind({object:'.ogx_chat[data-ogx-id="'+that.id+'"] .ogx_chat_emoji_search',property:config.emojis.map.search,mode:"in"})}function showEmojis(e){if(e){emojis.removeClass("ogx_chat_emojis_hidden");emoji_list.scroller.onResize()}else{emojis.addClass("ogx_chat_emojis_hidden")}listenEmojis(e)}function listenEmojis(e){if(e){emojis.on(that.touch.down,".ogx_chat_emoji",function(e){var t=that.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea");var i=t.val()+$(this).text();t.val(i)})}else{emojis.off(that.touch.down,".ogx_chat_emoji")}}function listenFile(e){if(e){that.el.on(that.touch.down,".ogx_chat_composer_attach",function(e){if(!attachment){OGX.Net.upload([".jpg",".png",".gif"],false,e=>{if(config.attach.width){e=OGX.Media.crop(e,e=>{attachment=e;var t=that.el.find(".ogx_chat_composer_attach");attach_icon=t.css("background-image");that.el.find(".ogx_chat_composer_attach").css("background-image","url("+e+")")},config.attach.width,config.attach.height)}})}else{attachment=null;that.el.find(".ogx_chat_composer_attach").css("background-image",attach_icon)}})}else{that.el.off(that.touch.down,".ogx_chat_composer_attach")}}function listenKeyb(e){if(e){window.addEventListener("native.keyboardshow",handleShowKeyb);window.addEventListener("native.keyboardhide",handleHideKeyb);window.addEventListener("keyboardDidShow",handleShowKeyb);window.addEventListener("keyboardDidHide",handleHideKeyb)}else{window.removeEventListener("native.keyboardshow",handleShowKeyb);window.removeEventListener("native.keyboardhide",handleHideKeyb);window.removeEventListener("keyboardDidShow",handleShowKeyb);window.removeEventListener("keyboardDidHide",handleHideKeyb)}}function listenArea(e){if(e){composer.on("keyup","textarea",function(e){if(e.which===13){sendMessage();if(config.hide_keyboard_on_send){handleHideKeyb()}}})}else{composer.off("keyup","textarea")}}function listenComposer(e){if(e){composer.on("click",".ogx_chat_composer_send",function(){sendMessage();if(config.hide_keyboard_on_send){handleHideKeyb()}});if(config.emojis){composer.on("click",".ogx_chat_composer_emoji",function(){showEmojis(emojis.hasClass("ogx_chat_emojis_hidden"))})}}else{composer.off("click",".ogx_chat_composer_send");if(config.emojis){composer.off("click",".ogx_chat_composer_emoji")}}}function initScroller(){scroller=that.create("Scroller",{el:that.el.find(".ogx_chat_messages")[0],initDelay:100,auto_scroll:true,trigger:true});inner=scroller.inner();inner=$(inner);inner.addClass("ogx_chat_messages_inner");scroller.mute();scroller.resize();render()}function initMarkup(){var e='<div class="ogx_chat_messages"></div>';if(config.emojis){e+='<div class= "ogx_chat_emojis ogx_chat_emojis_hidden"><input class="ogx_chat_emoji_search" type="text" placeholder="search"><span class="ogx_chat_emojis_list"></span></div>'}var t;config.read_only?t="hidden":t="";e+='<div class="ogx_chat_composer '+t+'">';e+='<span class="ogx_chat_composer_input"><textarea placeholder="'+config.placeholder+'">';e+="</textarea></span>";if(config.media){e+='<span class="ogx_chat_composer_attach"></span>'}if(config.emojis){e+='<span class="ogx_chat_composer_emoji"></span>'}e+='<span class="ogx_chat_composer_send"></span></div>';container.append(e);composer=container.find(".ogx_chat_composer");if(config.emojis){emojis=container.find(".ogx_chat_emojis");setTimeout(renderEmojis,10)}}function initUsers(){for(var e in config.users){typing[e]=false}}function initDefaults(){if(config.hasOwnProperty("emojis")&&config.emojis){OGX.Data.merge(config.emojis,emojis_default,false);config.emojis.list=new OGX.List(config.emojis.list)}OGX.Data.merge(config,config_default,false);if(!config.users.hasOwnProperty("find")){config.users=new OGX.List(config.users)}if(!config.callbacks.send){config.callbacks.send=that.onSend}container=that.el;container.addClass("ogx_chat")}function init(){initDefaults();initMarkup();initUsers();initScroller();if(config.restrict){var e=OGX.Data.clone(config.restrict);if(config.restrict.hasOwnProperty("forbidden")){e.forbidden=config.restrict.forbidden}if(config.restrict.hasOwnProperty("allowed")){e.allowed=config.restrict.allowed}e.el=that.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea")[0];OGX.Form.restrictField(e)}OGX.Form.bindField({el:".ogx_chat_composer .ogx_chat_composer_input textarea",input_cb:onInput});that.enable()}init()};OGX.Chat.SEND_MESSAGE="ChatSend";OGX.Chat.DISPLAY_INITIALS="ChatDisplayInitials";OGX.Chat.DISPLAY_PICTURE="ChatDisplayPicture";OGX.Chat.TYPING_START="ChatTypingStart";OGX.Chat.TYPING_END="ChatTypingEnd";