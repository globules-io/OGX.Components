/* OGX.JS Chat@1.4.0 */
if(typeof OGX==="undefined"){var OGX={}}require("Chat","Uxi","Touch");OGX.Chat=function(__config){construct(this,"Chat");"use strict";var that=this;var config=__config;var config_default={placeholder:"Type a message",dot_speed:600,on_keyb_update_delay:300,messages:[],handle_keyboard:true,hide_keyboard_on_send:false,emojis:false,media:true,attach:{width:800,height:800},template_left:'<div class="ogx_chat_message ogx_chat_message_left" style="{{$opacity}} data-id="{{$uid}}"><span class="ogx_chat_message_icon" style="{{$bg}}"><span>{{$letter}}</span></span><span class="ogx_chat_message_container"><span class="ogx_chat_message_body">{{$body}}</span><span class="ogx_chat_message_date">{{$date}}</span><span style="clear:both"></span></span></div>',template_right:'<div class="ogx_chat_message ogx_chat_message_right" style="{{$opacity}}" data-id="{{$uid}}"><span class="ogx_chat_message_container"><span class="ogx_chat_message_body">{{$body}}</span><span class="ogx_chat_message_date">{{$date}}</span><span style="clear:both"></span></span></div>',key:"_id",from_key:"from",users:[],user:false,display_mode:OGX.Chat.DISPLAY_INITIALS,picture_key:"",restrict:{multiline:false,length:500,allowed:/./},date_format:"YYYY-MM-DD h:mm:ss A",url_encode:true,read_only:false,callbacks:{send:null}};var emojis_default={template:'<span class="ogx_chat_emoji">{{$emoji}}</span>',button:false,list:[],map:{emoji:"char",search:"name"}};var container,inner,scroller,composer,emojis,emoji_list,intv;var oldh=false;var typing={};var type=".";var attachment=null;var attach_icon;this.onFocus=function(){if(!config.read_only){if(config.handle_keyboard){listenKeyb(true)}if(config.media&&config.attach){listenFile(true)}listenComposer(true);listenArea(true)}};this.onBlur=function(){if(!config.read_only){this.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea").trigger("blur");if(config.handle_keyboard){listenKeyb(false)}if(config.media&&config.attach){listenFile(false)}listenComposer(false);listenArea(false)}};this.readOnly=function(e){if(e){if(!config.read_only){this.el.find(".ogx_chat_composer").addClass("hidden");config.read_only=true}}else{if(config.read_only){this.el.find(".ogx_chat_composer").removeClass("hidden");config.read_only=false}}};this.users=function(e){if(typeof e!=="undefined"){if(!e.hasOwnProperty("find")){e=new OGX.List(e)}config.users=e;return true}return config.users};this.user=function(e){if(typeof e==="undefined"){return config.user}config.user=e;return this};this.typing=function(e,t){if(e&&!typing[t]){addTyping(t)}else{if(!e&&typing[t]){removeTyping(t)}}return this};this.compose=function(e){composer.find("textarea").val(e);return this};this.wipe=function(){inner.empty();return this};this.clear=function(){debug(2,"Chat clear is deprecated, use wipe");return this.wipe()};this.onSend=function(){};this.getScroller=function(){return scroller};this.addMessage=function(e){addMessage(e);return this};this.setMessages=function(e){config.messages=e;render();return this};this.prependMessages=function(e){var t=this.el.find(".ogx_scroller_outer").first();var i=inner.height();var o=t.scrollTop();for(var a=0;a<e.length;a++){addMessage(e[a],true)}config.messages=e.concat(config.messages);var s=inner.height();this.el.find(".ogx_scroller_outer").scrollTop(o+(s-i));return this};this.destroy=function(){if(config.restrict){OGX.Form.unrestrictField(that.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea")[0])}};function render(){if(config.messages.length>0){for(var e=0;e<config.messages.length;e++){addMessage(config.messages[e])}scroller.resize();scroller.bottom()}scroller.vocal()}function addMessage(__msg,__prepend){if(typeof __prepend==="undefined"){__prepend=false}scroller.observe(false);scroller.mute();var u=config.users.find(config.key,__msg[config.from_key],1);if(u){var msg=OGX.Data.clone(__msg);var initals=u.first_name.substr(0,1).toUpperCase()+u.last_name.substr(0,1).toUpperCase();switch(config.display_mode){case OGX.Chat.DISPLAY_INITIALS:msg.letter=initals;msg.bg="";break;case OGX.Chat.DISPLAY_PICTURE:msg.letter="";var e=eval("u."+config.picture_key);if(e!=="undefined"){msg.bg="background-image:url('"+e+"')"}else{msg.letter=initals;msg.bg=""}break}msg.uid=u[config.key];if(!__prepend){msg.opacity=""}else{msg.opacity="opacity:1;"}if(config.url_encode){msg.body=decodeURIComponent(msg.body)}if(config.media&&(__msg.hasOwnProperty("image")||__msg.hasOwnProperty("video"))){if(msg.hasOwnProperty("image")&&msg.image){msg.body='<span class="ogx_chat_message_media""><img src="{{$image}}"></span>'+msg.body}else{if(msg.hasOwnProperty("video")&&msg.video){msg.body='<span class="ogx_chat_message_media"><video controls autoplay src="{{$video}}"></video></span>'+msg.body}}}var html=OGX.Templater.make(getTemplate(msg),msg);if(!__prepend){inner.append(html)}else{inner.prepend(html)}var msg=inner.children(".ogx_chat_message:last");setTimeout(function(){msg.addClass("ogx_chat_message_anim");scroller.resize();if(!__prepend){scroller.bottom()}scroller.vocal();scroller.observe(true)},100)}else{}}function addTyping(e){typing[e]=true;var t='<div class="ogx_chat_typing" data-user="'+e+'"><span class="ogx_chat_typing_body">.</div></div>';inner.append(t);animTyping(true)}function removeTyping(e){typing[e]=false;inner.find('.ogx_chat_typing[data-user="'+e+'"]').remove();if(inner.find(".ogx_chat_typing").length===0){animTyping(false)}}function animTyping(e){if(e){if(!intv){intv=setInterval(typeDot,config.dot_speed)}}else{clearInterval(intv);intv=null}}function typeDot(){type+=".";type.length>3?type=".":null;inner.find(".ogx_chat_typing_body").html(type)}function getTemplate(e){if(e[config.from_key]===config.user){return config.template_right}else{return config.template_left}}function sendMessage(){var e=composer.find("textarea").val();if(e.length){e=e.replace(/^[\r|\n\r]+/,"");e=e.replace(/<\/?[^>]+(>|$)/g,"");e=e.replace(/â€™/,"'");if(e.length){e=e.replace(/[\r\n]/g,"<br>");var t={body:e,date:moment().format(config.date_format)};t[config.from_key]=config.user;if(attachment){t.image=attachment;attachment=null;that.el.find(".ogx_chat_composer_attach").css("background-image",attach_icon);attach_icon=null}addMessage(t);var i=OGX.Data.clone(t);if(config.url_encode){i.body=encodeURIComponent(i.body)}delete i.bg;delete i.letter;composer.find("textarea").val("");config.callbacks.send(i);that.el.trigger(OGX.Chat.SEND_MESSAGE,i)}}}function handleShowKeyb(e){if(!oldh){oldh=container.height()}container.height(oldh-e.keyboardHeight);updateScroller()}function handleHideKeyb(){container.height(oldh);updateScroller()}function updateScroller(){setTimeout(function(){scroller.resize();scroller.bottom()},config.on_keyb_update_delay)}function renderEmojis(){var e;var t=[];config.emojis.list=config.emojis.list.slice(0,250);for(var i=0;i<config.emojis.list.length;i++){e=OGX.Data.clone(config.emojis.list[i]);for(var o in config.emojis.map){e[o]=e[config.emojis.map[o]];t.push(e)}}emoji_list=that.create("DynamicList",{id:"ogx_chat_eml_"+that.id,el:'.ogx_chat[data-ogx-id="'+that.id+'"] .ogx_chat_emojis_list',key:"codes",scroll:true,display:{html:"{{$emoji}}",css:"ogx_chat_emoji"},list:t,callbacks:{render:e=>{e.scroller.onResize()}}});emoji_list.bind({object:'.ogx_chat[data-ogx-id="'+that.id+'"] .ogx_chat_emoji_search',property:config.emojis.map.search,mode:"in"})}function showEmojis(e){if(e){emojis.removeClass("ogx_chat_emojis_hidden");emoji_list.scroller.onResize()}else{emojis.addClass("ogx_chat_emojis_hidden")}listenEmojis(e)}function listenEmojis(e){if(e){emojis.on(that.touch.down,".ogx_chat_emoji",function(e){var t=that.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea");var i=t.val()+$(this).text();t.val(i)})}else{emojis.off(that.touch.down,".ogx_chat_emoji")}}function listenFile(e){if(e){that.el.on(that.touch.down,".ogx_chat_composer_attach",function(e){if(!attachment){OGX.Net.upload([".jpg",".png",".gif"],false,e=>{if(config.attach.width){e=OGX.Media.crop(e,e=>{attachment=e;var t=that.el.find(".ogx_chat_composer_attach");attach_icon=t.css("background-image");that.el.find(".ogx_chat_composer_attach").css("background-image","url("+e+")")},config.attach.width,config.attach.height)}})}else{attachment=null;that.el.find(".ogx_chat_composer_attach").css("background-image",attach_icon)}})}else{that.el.off(that.touch.down,".ogx_chat_composer_attach")}}function listenKeyb(e){if(e){window.addEventListener("native.keyboardshow",handleShowKeyb);window.addEventListener("native.keyboardhide",handleHideKeyb)}else{window.removeEventListener("native.keyboardshow",handleShowKeyb);window.removeEventListener("native.keyboardhide",handleHideKeyb)}}function listenArea(e){if(e){composer.on("keyup","textarea",function(e){if(e.which===13){sendMessage();if(config.hide_keyboard_on_send){handleHideKeyb()}}})}else{composer.off("keyup","textarea")}}function listenComposer(e){if(e){composer.on("click",".ogx_chat_composer_send",function(){sendMessage();if(config.hide_keyboard_on_send){handleHideKeyb()}});if(config.emojis){composer.on("click",".ogx_chat_composer_emoji",function(){showEmojis(emojis.hasClass("ogx_chat_emojis_hidden"))})}}else{composer.off("click",".ogx_chat_composer_send");if(config.emojis){composer.off("click",".ogx_chat_composer_emoji")}}}function initScroller(){scroller=that.create("Scroller",{el:that.el.find(".ogx_chat_messages")[0],initDelay:100,auto_scroll:true,trigger:true});inner=scroller.inner();inner=$(inner);inner.addClass("ogx_chat_messages_inner");scroller.mute();scroller.resize();render()}function initMarkup(){var e='<div class="ogx_chat_messages"></div>';if(config.emojis){e+='<div class= "ogx_chat_emojis ogx_chat_emojis_hidden"><input class="ogx_chat_emoji_search" type="text" placeholder="search"><span class="ogx_chat_emojis_list"></span></div>'}var t;config.read_only?t="hidden":t="";e+='<div class="ogx_chat_composer '+t+'">';e+='<span class="ogx_chat_composer_input"><textarea placeholder="'+config.placeholder+'">';e+="</textarea></span>";if(config.media){e+='<span class="ogx_chat_composer_attach"></span>'}if(config.emojis){e+='<span class="ogx_chat_composer_emoji"></span>'}e+='<span class="ogx_chat_composer_send"></span></div>';container.append(e);composer=container.find(".ogx_chat_composer");if(config.emojis){emojis=container.find(".ogx_chat_emojis");setTimeout(renderEmojis,10)}}function initUsers(){for(var e in config.users){typing[e]=false}}function initDefaults(){if(config.hasOwnProperty("emojis")&&config.emojis){OGX.Data.merge(config.emojis,emojis_default,false);config.emojis.list=new OGX.List(config.emojis.list)}OGX.Data.merge(config,config_default,false);if(!config.users.hasOwnProperty("find")){config.users=new OGX.List(config.users)}if(!config.callbacks.send){config.callbacks.send=that.onSend}container=that.el;container.addClass("ogx_chat")}function init(){initDefaults();initMarkup();initUsers();initScroller();if(config.restrict){var e=OGX.Data.clone(config.restrict);if(config.restrict.hasOwnProperty("forbidden")){e.forbidden=config.restrict.forbidden}if(config.restrict.hasOwnProperty("allowed")){e.allowed=config.restrict.allowed}e.el=that.el.find(".ogx_chat_composer .ogx_chat_composer_input textarea")[0];OGX.Form.restrictField(e)}that.enable()}init()};OGX.Chat.SEND_MESSAGE="ChatSend";OGX.Chat.DISPLAY_INITIALS="ChatDisplayInitials";OGX.Chat.DISPLAY_PICTURE="ChatDisplayPicture";