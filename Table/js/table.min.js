/* OGX.JS Table@1.4.0 */
require("Table","Uxi","Touch");OGX.Table=function(e){construct(this,"Table");"use strict";var r=this;var a={key:"_id",max_rows:30,resize_rows:false,prop_search:10,editable:false,mode:"row",display:{html:'<span class="ogx_table_row">{{$fields}}</span>',css:"ogx_table_row"},list:[],mapping:null};var d=OGX.Data.merge(e,a);var o,i;var s;var p=1;var _=0;var n=[];var u=null;var f=null;var h=null;var v=null;this.construct=function(){s=this.children("DynamicList")[0];if(d.mode==="item"){s.mode("hit")}i=o.children(".ogx_table_browse");y(true)};this.ux=function(e){if(e){this.on(this.touch.down,".ogx_table_page",l);this.on(this.touch.down,".ogx_table_prop",c)}else{this.off(this.touch.down,".ogx_table_page",l);this.off(this.touch.down,".ogx_table_prop",c);if(d.mode==="item"){this.off(this.touch.down,".ogx_table_row_value")}}};this.resize=function(){};this.destroy=function(){};this.mode=function(e){t(false);d.mode=e;if(d.mode==="item"){s.mode("hit");t(true)}else{s.mode("single")}};this.val=function(e){if(typeof e==="undefined"){return d.list}else{d.list=e;_=0;n=[];f=null;u=null;y(true)}};this.page=function(){return _};this.wipe=function(){p=1;_=0;s.wipe();m([]);return this};function t(e){if(e){r.on(r.touch.down,".ogx_table_row_value",function(e){var a=$(this);if(v){v.removeClass("ogx_table_row_value_selected")}v=a;var t={};t[d.key]={eq:a.parent().parent().data("ogx-id")};h=s.val().get(t,null,1);var l=n[a.index()].prop;a.addClass("ogx_table_row_value_selected");r.el.trigger(OGX.Table.SELECT,[l,h[l]])})}else{r.off(r.touch.down,".ogx_table_row_value")}}function l(e){var a=$(this).data("page");if(a!==_){_=a;y(false)}}function c(e){var a=$(this);var t=a.data("prop");var l=Number(a.attr("data-sort"));if(l===1){l=-1}else{l=1}u={prop:t,way:l};a.attr("data-sort",l);a.parent().children(".ogx_table_selected_prop").removeClass("ogx_table_selected_prop");a.addClass("ogx_table_selected_prop");_=0;y(false)}function g(e){var a=0;for(var t=0;t<e.length;t++){e[t].index>a?a=e[t].index+1:null}return a}function x(e,a){typeof a==="undefined"?a=0:null;var t=new OGX.List;for(var l=0;l<e.length;l++){if(a&&l>a){t.order("index",1);return t}var r,o;for(var i in e[l]){r=i;if(!t.get({prop:{eq:i}},null,1)){if(d.mapping&&d.mapping.hasOwnProperty(i)){r=d.mapping[i].label}if(d.mapping&&d.mapping[i].hasOwnProperty("index")){o=d.mapping[i].index}else{o=g(t)}t.push({prop:i,label:r,index:o})}}}t.order("index",1);return t}function b(e){var a="";var t=e.length;var l=100/t;for(var r=0;r<t;r++){a+='<span class="ogx_table_row_value" data-prop="'+e[r].prop+'" style="width:'+l+'%">{{';a+="typeof $"+e[r].prop+' === "object" && !Array.isArray($'+e[r].prop+') ? @val = "{...}" : @val = $'+e[r].prop+";";a+='typeof @val === "object" && Array.isArray(@val) ? @val = "[...]" : null;';a+='typeof @val === "string" && @val.indexOf("</") !== -1 ? @val = "&#60;/&#62;" : null;';a+="}}{{@val}}</span>"}return a}function m(e){var a="";var t=e.length;var l=100/t;for(var r=0;r<e.length;r++){a+='<span class="ogx_table_prop" data-prop="'+e[r].prop+'" data-sort="1" style="width:'+l+'%">'+e[r].label+"</span>"}o.children(".ogx_table_head").html(a)}function w(e){p=Math.ceil(e.length/d.max_rows);var a="";var t="";var l=2;var r,o;var i=[];var s=0;r=_-l;o=_+l+1;if(r<0){s=Math.abs(r)}else{if(o>p-1){s=o-p-1}}r+=s;o+=s;o>p-1?o=p-1:null;for(var n=r;n<o;n++){if(!i.includes(n)){i.push(n)}}if(!i.includes(0)){i.unshift(0)}if(!i.includes(p-1)){i.push(p-1)}for(var n=0;n<i.length;n++){if(i[n]===_){t="ogx_table_selected_page"}else{t=""}a+='<span class="ogx_table_page '+t+'" data-page="'+i[n]+'">'+(i[n]+1)+"</span>"}return a}function y(e){var a=d.list;!a.hasOwnProperty("insert")?a=new OGX.List(a):null;if(a.length){s.wipe();if(u){a.order(u.prop,u.way)}if(e){n=x(a,d.prop_search);var t=b(n);m(n);f=d.display.html;f=f.replace("{{$fields}}",t)}s.display({display:{html:f,css:"ogx_table_row"}});if(a.length>d.max_rows){a=OGX.Data.clone(a).splice(_*d.max_rows,_*d.max_rows+d.max_rows);var l=w(d.list);i.html(l).removeClass("ogx_table_hidden")}else{i.html("").addClass("ogx_table_hidden")}s.val(a)}else{i.html("").addClass("ogx_table_hidden");m([]);s.val([])}}function O(){o=r.el;o.addClass("ogx_table");var e='<div class="ogx_table_head"></div><div class="ogx_table_rows"></div><div class="ogx_table_browse ogx_table_hidden"></div>';o.html(e);var a={"default > .ogx_table_rows:DynamicList":{key:d.key,scroll:true,scope:false,display:OGX.Data.clone(d.display)}};d["node:OML"]=OGX.OML.rename(a,'.ogx_uxi[data-ogx-id="'+r.id+'"]')}O()};OGX.Table.SELECT="tableSelect";